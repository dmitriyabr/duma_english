// Prisma schema for AI Speaking Trainer MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Teacher {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  classes   Class[]
}

model Class {
  id        String   @id @default(cuid())
  name      String
  teacherId String
  createdAt DateTime @default(now())

  teacher   Teacher   @relation(fields: [teacherId], references: [id])
  codes     ClassCode[]
  students  Student[]
}

model ClassCode {
  id        String   @id @default(cuid())
  classId   String
  code      String   @unique
  expiresAt DateTime?
  maxUses   Int?
  usesCount Int      @default(0)
  status    String   @default("active")
  createdAt DateTime @default(now())

  class     Class    @relation(fields: [classId], references: [id])

  @@index([classId])
}

model Student {
  id          String   @id @default(cuid())
  classId     String
  displayName String
  createdAt   DateTime @default(now())

  class      Class              @relation(fields: [classId], references: [id])
  attempts   Attempt[]
  progress   ProgressDaily[]
  metrics    AttemptMetric[]
  skillDaily StudentSkillDaily[]
  profile    LearnerProfile?
  mastery    StudentSkillMastery[]
  vocabulary StudentVocabulary[]
  placementSessions PlacementSession[]
  gseMastery StudentGseMastery[]
  gseEvidence AttemptGseEvidence[]

  @@index([classId])
}

model Task {
  id        String   @id @default(cuid())
  type      String
  prompt    String
  level     Int      @default(1)
  metaJson  Json?
  createdAt DateTime @default(now())

  attempts Attempt[]
  gseTargets TaskGseTarget[]
}

model Attempt {
  id               String   @id @default(cuid())
  studentId        String
  taskId           String
  status           String   @default("created")
  audioObjectKey   String?
  durationSec      Float?
  transcript       String?
  speechMetricsJson Json?
  rawRecognitionJson Json?
  taskEvaluationJson Json?
  aiDebugJson       Json?
  scoresJson       Json?
  feedbackJson     Json?
  errorCode        String?
  errorMessage     String?
  createdAt        DateTime @default(now())
  completedAt      DateTime?

  student  Student         @relation(fields: [studentId], references: [id])
  task     Task            @relation(fields: [taskId], references: [id])
  metrics  AttemptMetric[]
  gseEvidence AttemptGseEvidence[]

  @@index([studentId])
  @@index([status])
}

model AttemptMetric {
  id                 String   @id @default(cuid())
  attemptId          String
  studentId          String
  metricKey          String
  value              Float
  source             String
  reliability        String
  calculationVersion String
  createdAt          DateTime @default(now())

  attempt Attempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([studentId, metricKey])
}

model StudentSkillDaily {
  id          String   @id @default(cuid())
  studentId   String
  date        DateTime
  skillKey    String
  value       Float
  sampleCount Int      @default(1)
  reliability String
  createdAt   DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, date, skillKey])
  @@index([studentId, skillKey, date])
}

model LearnerProfile {
  id                  String   @id @default(cuid())
  studentId           String   @unique
  stage               String   @default("A0")
  ageBand             String   @default("9-11")
  placementScore      Float?
  placementConfidence Float?
  activeTrack         String   @default("balanced_convo_speech")
  cycleWeek           Int      @default(1)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model StudentSkillMastery {
  id             String   @id @default(cuid())
  studentId      String
  skillKey       String
  masteryScore   Float
  evidenceCount  Int      @default(0)
  reliability    String
  lastAssessedAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, skillKey])
  @@index([studentId])
}

model StudentVocabulary {
  id                String   @id @default(cuid())
  studentId         String
  lemma             String
  status            String   @default("new")
  nextReviewAt      DateTime?
  retentionScore    Float    @default(0)
  usageEvidenceCount Int     @default(0)
  sourceTopicId     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, lemma])
  @@index([studentId, status, nextReviewAt])
}

model PlacementSession {
  id           String   @id @default(cuid())
  studentId    String
  status       String   @default("started")
  currentIndex Int      @default(0)
  responsesJson Json?
  resultJson   Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  completedAt  DateTime?

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, status])
}

model ProgressDaily {
  id         String   @id @default(cuid())
  studentId  String
  date       DateTime
  metricsJson Json
  createdAt  DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id])

  @@unique([studentId, date])
}

model GseCatalogVersion {
  id          String   @id @default(cuid())
  version     String   @unique
  source      String
  description String?
  metadataJson Json?
  createdAt   DateTime @default(now())

  nodes GseNode[]
}

model GseNode {
  id              String   @id @default(cuid())
  nodeId          String   @unique
  sourceKey       String
  type            String
  catalog         String
  gseMin          Int?
  gseMax          Int?
  gseCenter       Float?
  cefrBand        String?
  audience        String?
  skill           String?
  descriptor      String
  source          String
  sourceVersion   String?
  licenseTag      String?
  metadataJson    Json?
  catalogVersionId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  catalogVersion GseCatalogVersion @relation(fields: [catalogVersionId], references: [id], onDelete: Cascade)
  aliases        GseNodeAlias[]
  outgoingEdges  GseNodeEdge[] @relation("GseNodeEdgeFrom")
  incomingEdges  GseNodeEdge[] @relation("GseNodeEdgeTo")
  attemptEvidence AttemptGseEvidence[]
  mastery         StudentGseMastery[]
  taskTargets     TaskGseTarget[]

  @@index([catalogVersionId, type])
  @@index([catalogVersionId, audience, skill])
}

model GseNodeAlias {
  id        String   @id @default(cuid())
  nodeId    String
  alias     String
  source    String
  createdAt DateTime @default(now())

  node GseNode @relation(fields: [nodeId], references: [nodeId], onDelete: Cascade)

  @@unique([nodeId, alias])
  @@index([alias])
}

model GseNodeEdge {
  id         String   @id @default(cuid())
  fromNodeId String
  toNodeId   String
  edgeType   String
  weight     Float?
  metadataJson Json?
  createdAt  DateTime @default(now())

  fromNode GseNode @relation("GseNodeEdgeFrom", fields: [fromNodeId], references: [nodeId], onDelete: Cascade)
  toNode   GseNode @relation("GseNodeEdgeTo", fields: [toNodeId], references: [nodeId], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId, edgeType])
  @@index([toNodeId, edgeType])
}

model AttemptGseEvidence {
  id          String   @id @default(cuid())
  attemptId   String
  studentId   String
  nodeId      String
  signalType  String
  confidence  Float
  impact      Float
  evidenceText String?
  metadataJson Json?
  createdAt   DateTime @default(now())

  attempt Attempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  node    GseNode @relation(fields: [nodeId], references: [nodeId], onDelete: Cascade)

  @@index([attemptId])
  @@index([studentId, nodeId])
}

model StudentGseMastery {
  id               String   @id @default(cuid())
  studentId        String
  nodeId           String
  masteryScore     Float
  evidenceCount    Int      @default(0)
  reliability      String
  lastEvidenceAt   DateTime?
  decayStateJson   Json?
  spacingStateJson Json?
  calculationVersion String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  node    GseNode @relation(fields: [nodeId], references: [nodeId], onDelete: Cascade)

  @@unique([studentId, nodeId])
  @@index([studentId, masteryScore])
}

model TaskGseTarget {
  id        String   @id @default(cuid())
  taskId    String
  nodeId    String
  weight    Float    @default(1)
  required  Boolean  @default(false)
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  node GseNode @relation(fields: [nodeId], references: [nodeId], onDelete: Cascade)

  @@unique([taskId, nodeId])
  @@index([nodeId])
}
